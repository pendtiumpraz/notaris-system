generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ==================== ENUMS ====================

enum UserRole {
  SUPER_ADMIN
  ADMIN
  STAFF
  CLIENT
}

enum DocumentStatus {
  DRAFT
  SUBMITTED
  IN_REVIEW
  WAITING_SIGNATURE
  COMPLETED
  CANCELLED
}

enum DocumentPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum AppointmentStatus {
  PENDING
  CONFIRMED
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum NotificationType {
  DOCUMENT_UPDATE
  APPOINTMENT_REMINDER
  NEW_MESSAGE
  SYSTEM
  INVOICE_UPDATE
}

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  PARTIALLY_PAID
  OVERDUE
  CANCELLED
}

enum PaymentMethod {
  CASH
  BANK_TRANSFER
  QRIS
  CREDIT_CARD
  OTHER
}

// ==================== USER MANAGEMENT ====================

model User {
  id               String    @id @default(uuid())
  email            String    @unique
  passwordHash     String?   @map("password_hash")
  name             String
  phone            String?
  role             UserRole  @default(CLIENT)
  avatarUrl        String?   @map("avatar_url")
  emailVerifiedAt  DateTime? @map("email_verified_at")
  twoFactorEnabled Boolean   @default(false) @map("two_factor_enabled")
  twoFactorSecret  String?   @map("two_factor_secret")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")
  deletedAt        DateTime? @map("deleted_at")

  // Relations
  client               Client?
  staff                Staff?
  sessions             Session[]
  notifications        Notification[]
  notificationSettings NotificationSettings?
  auditLogs            AuditLog[]
  uploadedFiles        DocumentFile[]         @relation("FileUploader")
  sentMessages         Message[]
  conversationParts    ConversationParticipant[]
  timelineChanges      DocumentTimeline[]
  connectedDrives      GoogleDrive[]
  aiResults            AIResult[]
  createdInvoices      Invoice[]              @relation("InvoiceCreator")
  receivedPayments     Payment[]              @relation("PaymentReceiver")
  createdTemplates     DocumentTemplate[]     @relation("TemplateCreator")
  verifiedChecklists   DocumentChecklist[]    @relation("ChecklistVerifier")

  // NextAuth relations
  accounts Account[]

  @@index([email])
  @@index([role])
  @@index([deletedAt])
  @@map("users")
}

model Account {
  id                String  @id @default(uuid())
  userId            String  @map("user_id")
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Client {
  id             String    @id @default(uuid())
  userId         String    @unique @map("user_id")
  clientNumber   String    @unique @map("client_number")
  companyName    String?   @map("company_name")
  address        String?
  idNumber       String?   @map("id_number")

  // Notaris-specific fields
  nik            String?   // Nomor Induk Kependudukan (16 digit)
  npwp           String?   // Nomor Pokok Wajib Pajak
  birthPlace     String?   @map("birth_place") // Tempat lahir
  birthDate      DateTime? @map("birth_date")  // Tanggal lahir
  religion       String?   // Agama
  maritalStatus  String?   @map("marital_status") // Status perkawinan
  occupation     String?   // Pekerjaan
  nationality    String?   @default("WNI") // Kewarganegaraan
  spouseName     String?   @map("spouse_name") // Nama pasangan
  rtRw           String?   @map("rt_rw") // RT/RW
  kelurahan      String?   // Kelurahan/Desa
  kecamatan      String?   // Kecamatan
  city           String?   // Kota/Kabupaten
  province       String?   // Provinsi
  postalCode     String?   @map("postal_code") // Kode pos

  metadata       Json?
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  // Relations
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  documents    Document[]
  appointments Appointment[]
  invoices     Invoice[]

  @@index([userId])
  @@index([clientNumber])
  @@index([nik])
  @@map("clients")
}

model Staff {
  id              String   @id @default(uuid())
  userId          String   @unique @map("user_id")
  branchId        String?  @map("branch_id")
  employeeId      String   @unique @map("employee_id")
  position        String?
  specializations Json?
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  user          User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  branch        Branch?            @relation(fields: [branchId], references: [id])
  documents     Document[]
  appointments  Appointment[]
  availability  StaffAvailability[]

  @@index([userId])
  @@index([branchId])
  @@map("staff")
}

model Branch {
  id        String    @id @default(uuid())
  name      String
  address   String?
  phone     String?
  email     String?
  isActive  Boolean   @default(true) @map("is_active")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  // Relations
  staff Staff[]

  @@map("branches")
}

// ==================== DOCUMENT MANAGEMENT ====================

model Document {
  id             String           @id @default(uuid())
  documentNumber String           @unique @map("document_number")
  clientId       String           @map("client_id")
  staffId        String?          @map("staff_id")
  documentTypeId String           @map("document_type_id")
  title          String
  description    String?
  status         DocumentStatus   @default(DRAFT)
  priority       DocumentPriority @default(NORMAL)
  dueDate        DateTime?        @map("due_date")
  completedAt    DateTime?        @map("completed_at")
  metadata       Json?
  createdAt      DateTime         @default(now()) @map("created_at")
  updatedAt      DateTime         @updatedAt @map("updated_at")
  deletedAt      DateTime?        @map("deleted_at")

  // Relations
  client       Client             @relation(fields: [clientId], references: [id])
  staff        Staff?             @relation(fields: [staffId], references: [id])
  documentType DocumentType       @relation(fields: [documentTypeId], references: [id])
  files        DocumentFile[]
  timeline     DocumentTimeline[]
  conversation Conversation?
  appointments Appointment[]
  aiResults    AIResult[]
  invoices     Invoice[]
  checklists   DocumentChecklist[]

  @@index([clientId])
  @@index([staffId])
  @@index([status])
  @@index([documentNumber])
  @@index([createdAt])
  @@map("documents")
}

model DocumentType {
  id                    String    @id @default(uuid())
  name                  String
  description           String?
  requiredDocuments     Json?     @map("required_documents")
  estimatedDurationDays Int?      @map("estimated_duration_days")
  isActive              Boolean   @default(true) @map("is_active")
  createdAt             DateTime  @default(now()) @map("created_at")

  // Relations
  documents Document[]
  templates DocumentTemplate[]

  @@map("document_types")
}

model GoogleDrive {
  id           String    @id @default(uuid())
  accessToken  String    @map("access_token") @db.Text
  refreshToken String    @map("refresh_token") @db.Text
  tokenExpiry  DateTime  @map("token_expiry")
  email        String    @unique
  accountName  String?   @map("account_name")
  rootFolderId String?   @map("root_folder_id")
  storageUsed  BigInt    @default(0) @map("storage_used")
  storageLimit BigInt    @default(16106127360) @map("storage_limit") // 15GB default
  isActive     Boolean   @default(false) @map("is_active")
  isConnected  Boolean   @default(true) @map("is_connected")
  connectedAt  DateTime  @default(now()) @map("connected_at")
  connectedBy  String    @map("connected_by")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  // Relations
  connectedByUser User           @relation(fields: [connectedBy], references: [id])
  files           DocumentFile[]

  @@map("google_drives")
}

model DocumentFile {
  id           String    @id @default(uuid())
  documentId   String    @map("document_id")
  driveId      String?   @map("drive_id")
  driveFileId  String?   @map("drive_file_id")
  driveLink    String?   @map("drive_link")
  uploadedBy   String    @map("uploaded_by")
  fileName     String    @map("file_name")
  originalName String    @map("original_name")
  fileSize     BigInt    @map("file_size")
  mimeType     String    @map("mime_type")
  createdAt    DateTime  @default(now()) @map("created_at")
  deletedAt    DateTime? @map("deleted_at")

  // Relations
  document Document     @relation(fields: [documentId], references: [id])
  drive    GoogleDrive? @relation(fields: [driveId], references: [id])
  uploader User         @relation("FileUploader", fields: [uploadedBy], references: [id])

  @@index([documentId])
  @@map("document_files")
}

model DocumentTimeline {
  id         String         @id @default(uuid())
  documentId String         @map("document_id")
  changedBy  String         @map("changed_by")
  status     DocumentStatus
  notes      String?
  createdAt  DateTime       @default(now()) @map("created_at")

  // Relations
  document Document @relation(fields: [documentId], references: [id])
  user     User     @relation(fields: [changedBy], references: [id])

  @@index([documentId])
  @@index([createdAt])
  @@map("document_timeline")
}

// ==================== APPOINTMENTS ====================

model Appointment {
  id              String            @id @default(uuid())
  clientId        String            @map("client_id")
  staffId         String?           @map("staff_id")
  serviceId       String            @map("service_id")
  documentId      String?           @map("document_id")
  scheduledAt     DateTime          @map("scheduled_at")
  durationMinutes Int               @map("duration_minutes")
  status          AppointmentStatus @default(PENDING)
  notes           String?
  createdAt       DateTime          @default(now()) @map("created_at")
  updatedAt       DateTime          @updatedAt @map("updated_at")
  cancelledAt     DateTime?         @map("cancelled_at")

  // Relations
  client   Client    @relation(fields: [clientId], references: [id])
  staff    Staff?    @relation(fields: [staffId], references: [id])
  service  Service   @relation(fields: [serviceId], references: [id])
  document Document? @relation(fields: [documentId], references: [id])

  @@index([clientId])
  @@index([staffId])
  @@index([scheduledAt])
  @@index([status])
  @@map("appointments")
}

model Service {
  id              String   @id @default(uuid())
  name            String
  description     String?
  durationMinutes Int      @map("duration_minutes")
  isActive        Boolean  @default(true) @map("is_active")
  createdAt       DateTime @default(now()) @map("created_at")

  // Relations
  appointments Appointment[]

  @@map("services")
}

model StaffAvailability {
  id          String   @id @default(uuid())
  staffId     String   @map("staff_id")
  dayOfWeek   Int      @map("day_of_week") // 0-6 (Sunday-Saturday)
  startTime   String   @map("start_time") // HH:mm format
  endTime     String   @map("end_time")   // HH:mm format
  isAvailable Boolean  @default(true) @map("is_available")
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  staff Staff @relation(fields: [staffId], references: [id])

  @@index([staffId])
  @@index([dayOfWeek])
  @@map("staff_availability")
}

// ==================== MESSAGING ====================

model Conversation {
  id         String    @id @default(uuid())
  documentId String?   @unique @map("document_id")
  subject    String?
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")
  closedAt   DateTime? @map("closed_at")

  // Relations
  document     Document?                 @relation(fields: [documentId], references: [id])
  participants ConversationParticipant[]
  messages     Message[]

  @@index([documentId])
  @@map("conversations")
}

model ConversationParticipant {
  id             String    @id @default(uuid())
  conversationId String    @map("conversation_id")
  userId         String    @map("user_id")
  lastReadAt     DateTime? @map("last_read_at")
  createdAt      DateTime  @default(now()) @map("created_at")

  // Relations
  conversation Conversation @relation(fields: [conversationId], references: [id])
  user         User         @relation(fields: [userId], references: [id])

  @@unique([conversationId, userId])
  @@map("conversation_participants")
}

model Message {
  id             String    @id @default(uuid())
  conversationId String    @map("conversation_id")
  senderId       String    @map("sender_id")
  content        String
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")
  deletedAt      DateTime? @map("deleted_at")

  // Relations
  conversation Conversation        @relation(fields: [conversationId], references: [id])
  sender       User                @relation(fields: [senderId], references: [id])
  attachments  MessageAttachment[]

  @@index([conversationId])
  @@index([senderId])
  @@index([createdAt])
  @@map("messages")
}

model MessageAttachment {
  id        String   @id @default(uuid())
  messageId String   @map("message_id")
  fileName  String   @map("file_name")
  filePath  String   @map("file_path")
  fileSize  BigInt   @map("file_size")
  mimeType  String   @map("mime_type")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  message Message @relation(fields: [messageId], references: [id])

  @@map("message_attachments")
}

// ==================== NOTIFICATIONS ====================

model Notification {
  id        String           @id @default(uuid())
  userId    String           @map("user_id")
  type      NotificationType
  title     String
  body      String?
  data      Json?
  readAt    DateTime?        @map("read_at")
  createdAt DateTime         @default(now()) @map("created_at")
  deletedAt DateTime?        @map("deleted_at")

  // Relations
  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([readAt])
  @@index([createdAt])
  @@map("notifications")
}

model NotificationSettings {
  id              String    @id @default(uuid())
  userId          String    @unique @map("user_id")
  emailEnabled    Boolean   @default(true) @map("email_enabled")
  smsEnabled      Boolean   @default(false) @map("sms_enabled")
  pushEnabled     Boolean   @default(true) @map("push_enabled")
  quietHoursStart String?   @map("quiet_hours_start") // HH:mm format
  quietHoursEnd   String?   @map("quiet_hours_end")   // HH:mm format
  preferences     Json?
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id])

  @@map("notification_settings")
}

// ==================== SECURITY & AUDIT ====================

model Session {
  id         String    @id @default(uuid())
  userId     String    @map("user_id")
  tokenHash  String    @map("token_hash")
  deviceInfo Json?     @map("device_info")
  ipAddress  String?   @map("ip_address")
  expiresAt  DateTime  @map("expires_at")
  createdAt  DateTime  @default(now()) @map("created_at")
  revokedAt  DateTime? @map("revoked_at")

  // Relations
  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([tokenHash])
  @@index([expiresAt])
  @@map("sessions")
}

model AuditLog {
  id           String   @id @default(uuid())
  userId       String?  @map("user_id")
  action       String
  resourceType String   @map("resource_type")
  resourceId   String?  @map("resource_id")
  oldValues    Json?    @map("old_values")
  newValues    Json?    @map("new_values")
  ipAddress    String?  @map("ip_address")
  userAgent    String?  @map("user_agent")
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  user User? @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([resourceType, resourceId])
  @@index([createdAt])
  @@map("audit_logs")
}

// ==================== CONTENT MANAGEMENT ====================

model SiteSettings {
  id          String   @id @default(uuid())
  key         String   @unique
  value       String   @db.Text
  type        String   @default("text") // text, json, html
  description String?
  updatedAt   DateTime @updatedAt @map("updated_at")
  updatedBy   String?  @map("updated_by")

  @@map("site_settings")
}

model FAQ {
  id        String    @id @default(uuid())
  question  String
  answer    String    @db.Text
  category  String?
  order     Int       @default(0)
  isActive  Boolean   @default(true) @map("is_active")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  @@index([isActive])
  @@index([order])
  @@map("faqs")
}

model Testimonial {
  id          String    @id @default(uuid())
  clientName  String    @map("client_name")
  clientTitle String?   @map("client_title")
  clientPhoto String?   @map("client_photo")
  content     String    @db.Text
  rating      Int       @default(5)
  isActive    Boolean   @default(true) @map("is_active")
  isFeatured  Boolean   @default(false) @map("is_featured")
  order       Int       @default(0)
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  deletedAt   DateTime? @map("deleted_at")

  @@index([isActive])
  @@index([isFeatured])
  @@map("testimonials")
}

model TeamMember {
  id          String    @id @default(uuid())
  name        String
  position    String
  photo       String?
  bio         String?   @db.Text
  email       String?
  phone       String?
  order       Int       @default(0)
  isActive    Boolean   @default(true) @map("is_active")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  deletedAt   DateTime? @map("deleted_at")

  @@index([isActive])
  @@map("team_members")
}

model ServiceInfo {
  id          String    @id @default(uuid())
  title       String
  description String    @db.Text
  icon        String?
  features    Json?
  price       String?
  order       Int       @default(0)
  isActive    Boolean   @default(true) @map("is_active")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  deletedAt   DateTime? @map("deleted_at")

  @@index([isActive])
  @@map("service_infos")
}

model GalleryImage {
  id        String    @id @default(uuid())
  title     String?
  imageUrl  String    @map("image_url")
  category  String?
  order     Int       @default(0)
  isActive  Boolean   @default(true) @map("is_active")
  createdAt DateTime  @default(now()) @map("created_at")
  deletedAt DateTime? @map("deleted_at")

  @@index([isActive])
  @@map("gallery_images")
}

// ==================== AI RESULTS ====================

model AIResult {
  id           String   @id @default(uuid())
  documentId   String?  @map("document_id")
  userId       String   @map("user_id")
  action       String   // generate, analyze, correct, revise, summarize, translate, letter, compare, checklist, extract, risk_assessment
  prompt       String?  @db.Text
  result       String   @db.Text // HTML or JSON string result
  resultJson   Json?    @map("result_json") // Structured JSON result for parsed UI
  provider     String?  // deepseek, openai, gemini
  model        String?  // model id used
  tokensUsed   Int?     @map("tokens_used")
  durationMs   Int?     @map("duration_ms") // How long the AI call took
  metadata     Json?    // Additional metadata
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  document Document? @relation(fields: [documentId], references: [id])
  user     User      @relation(fields: [userId], references: [id])

  @@index([documentId])
  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@map("ai_results")
}

// ==================== LICENSE ====================

model License {
  id            String    @id @default(uuid())
  licenseKey    String    @unique @map("license_key")
  packageType   String    @map("package_type") // complete, no_ai, limited_ai
  domain        String    // Bound domain (e.g. notaris.example.com)
  holderName    String?   @map("holder_name") // Name of the license holder (notaris)
  officeName    String?   @map("office_name") // Name of notary office
  activatedAt   DateTime  @default(now()) @map("activated_at")
  expiresAt     DateTime? @map("expires_at") // null = lifetime
  lastVerified  DateTime? @map("last_verified")
  isActive      Boolean   @default(true) @map("is_active")
  serverHash    String?   @map("server_hash") // Hash of server identifier for extra binding
  metadata      Json?     // Extra data from license server

  @@map("licenses")
}

// ==================== BILLING & INVOICES ====================

model Invoice {
  id             String        @id @default(uuid())
  invoiceNumber  String        @unique @map("invoice_number") // e.g. INV-2026-0001
  clientId       String        @map("client_id")
  documentId     String?       @map("document_id")
  createdById    String        @map("created_by_id")
  status         InvoiceStatus @default(DRAFT)
  subtotal       Float         @default(0)
  taxPercent     Float         @default(0) @map("tax_percent")
  taxAmount      Float         @default(0) @map("tax_amount")
  discount       Float         @default(0)
  totalAmount    Float         @default(0) @map("total_amount")
  paidAmount     Float         @default(0) @map("paid_amount")
  notes          String?       @db.Text
  dueDate        DateTime?     @map("due_date")
  sentAt         DateTime?     @map("sent_at")
  paidAt         DateTime?     @map("paid_at")
  createdAt      DateTime      @default(now()) @map("created_at")
  updatedAt      DateTime      @updatedAt @map("updated_at")

  // Relations
  client    Client        @relation(fields: [clientId], references: [id])
  document  Document?     @relation(fields: [documentId], references: [id])
  createdBy User          @relation("InvoiceCreator", fields: [createdById], references: [id])
  items     InvoiceItem[]
  payments  Payment[]

  @@index([clientId])
  @@index([documentId])
  @@index([status])
  @@index([dueDate])
  @@index([createdAt])
  @@map("invoices")
}

model InvoiceItem {
  id          String  @id @default(uuid())
  invoiceId   String  @map("invoice_id")
  description String
  quantity    Int     @default(1)
  unitPrice   Float   @map("unit_price")
  amount      Float   @default(0)
  order       Int     @default(0)

  // Relations
  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
  @@map("invoice_items")
}

model Payment {
  id            String        @id @default(uuid())
  invoiceId     String        @map("invoice_id")
  amount        Float
  method        PaymentMethod @default(BANK_TRANSFER)
  reference     String?       // Nomor referensi / bukti transfer
  notes         String?
  receivedById  String?       @map("received_by_id")
  paidAt        DateTime      @default(now()) @map("paid_at")
  createdAt     DateTime      @default(now()) @map("created_at")

  // Relations
  invoice    Invoice @relation(fields: [invoiceId], references: [id])
  receivedBy User?   @relation("PaymentReceiver", fields: [receivedById], references: [id])

  @@index([invoiceId])
  @@index([paidAt])
  @@map("payments")
}

// ==================== DOCUMENT TEMPLATES ====================

model DocumentTemplate {
  id              String   @id @default(uuid())
  name            String
  description     String?
  documentTypeId  String?  @map("document_type_id")
  content         String   @db.Text // Template content with {{placeholders}}
  placeholders    Json?    // List of available placeholders with labels
  category        String?  // e.g. Akta, Surat, Perjanjian
  isActive        Boolean  @default(true) @map("is_active")
  createdById     String   @map("created_by_id")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  documentType DocumentType? @relation(fields: [documentTypeId], references: [id])
  createdBy    User          @relation("TemplateCreator", fields: [createdById], references: [id])

  @@index([documentTypeId])
  @@index([category])
  @@index([isActive])
  @@map("document_templates")
}

// ==================== DOCUMENT CHECKLIST ====================

model DocumentChecklist {
  id          String   @id @default(uuid())
  documentId  String   @map("document_id")
  label       String   // e.g. "KTP Asli", "Sertifikat Tanah"
  isRequired  Boolean  @default(true) @map("is_required")
  isCompleted Boolean  @default(false) @map("is_completed")
  completedAt DateTime? @map("completed_at")
  verifiedBy  String?  @map("verified_by") // Staff yang verifikasi
  verifiedAt  DateTime? @map("verified_at")
  notes       String?
  order       Int      @default(0)
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  document Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  verifier User?    @relation("ChecklistVerifier", fields: [verifiedBy], references: [id])

  @@index([documentId])
  @@map("document_checklists")
}
